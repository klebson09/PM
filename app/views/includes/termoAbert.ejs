<html>
  <head>
    <meta charset="UTF-8">
    <title>Termo de Abertura</title>
    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>
    <!-- Bootstrap 3.3.2 -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!-- Font Awesome Icons -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <!-- Theme style -->
    <link href="dist/css/AdminLTE.min.css" rel="stylesheet" type="text/css" />
    <!-- iCheck -->
    <link href="plugins/iCheck/square/blue.css" rel="stylesheet" type="text/css" />
    <link href="dist/css/skins/_all-skins.min.css" rel="stylesheet" type="text/css" />
    <link href="tabulator-master/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="tabulator-master/dist/css/bootstrap/tabulator_bootstrap4.min.css" rel="stylesheet">
    <link href="tabulator-master/dist/css/semantic-ui/tabulator_semantic-ui.min.css" rel="stylesheet">
  </head>
  <body class="skin-green">
    <!-- Site wrapper -->
    <div class="wrapper">
      <!-- Right side column. Contains the navbar and content of the page -->
      <div class="content-wrapper">
        <div id="modalErroValidacaoTA" class="modal modal-danger fade-in" role="dialog">
              <div class="modal-dialog">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h5 class="modal-title">Atenção</h5>
                      </div>
                      <div class="modal-body">
                          <p><small><div id="msgsTAErro"></div></small></p>
                      </div>
                      <div class="modal-footer">
                          <button type="button" class="btn btn-outline pull-right" data-dismiss="modal">Fechar</button>
                      </div>
                  </div>
              </div>
          </div> 
        <!-- Main content -->
        <section class="content">
          <div class="row">
            <div class="col-md-offset-2 col-md-8">
              <div class="box box-success">

                <form id="msform" action="/criar_termo_abertura" method="post" >
                  <!-- fieldsets -->
                  <fieldset>
                    <!-- <div class="box box-success"> -->
                    <h2 class="fs-title col-md-offset-1" id="tituloForm" style="padding-bottom: 20px;">  Termo de Abertura</h2>
                    <!-- <h3 class="fs-subtitle">This is step 1</h3> -->

                    <input type="hidden" id="tituloProj" class="form-control" name="idProjeto" value="<%= dadosTermoAbertura.idProjeto %>" />



                    <div class="form-group  col-md-12 ">
                      <label for="nomeProjeto">Título do Projeto</label>
                      <input type="text" id="nomeProjeto" name="nomeProjeto" class="form-control"  value="<%= dadosProjeto.nomeProjeto %>"  readonly  />
                    </div>


                    <div class="form-group  col-md-12 ">
                      <label for="tituloProj">Plataforma</label>
                      <input type="text" id="plataforma" class="form-control" value="<%=dadosProjeto.nome %>"  readonly  />
                    </div>

                    <div class="form-group col-md-12">
                    <label for="escopoProj">Descrição</label>
                    <textarea class="form-control" id="descricao" rows="8" value=""  readonly><%=dadosProjeto.descricao %></textarea>
                    </div>
                    <div class="form-group col-md-12">
                      <label for="escopoNegativoProj">Finalidade</label>
                      <textarea class="form-control"  id="finalidade" rows="8" value=""  readonly ><%=dadosProjeto.finalidade %></textarea>
                    </div>
                    <div class="form-group col-md-12">
                      <label for="interfacesOutrosSistemasProj">Área de atuação</label>
                      <textarea class="form-control" id="areaAtuacao" rows="5" value=""  readonly ><%=dadosProjeto.areaAtuacao %></textarea>
                    </div>     




                    <div class="form-group col-md-12">
                      <label for="objetivoProj">Objetivo</label>
                      <textarea class="form-control" name="objetivoProjeto" id="objetivoProj" rows="5" ></textarea>
                    </div>
                    <div class="form-group col-md-12">
                      <label for="escopoProj">Escopo</label>
                      <textarea class="form-control" name="escopoProjeto" id="escopoProj" rows="8" ></textarea>
                    </div>
                    <div class="form-group col-md-12">
                      <label for="escopoNegativoProj">Escopo Negativo</label>
                      <textarea class="form-control" name="escopoNegativoProjeto" id="escopoNegativoProj" rows="8" ></textarea>
                    </div>
                    <div class="form-group col-md-12">
                      <label for="interfacesOutrosSistemasProj">Interfaces com Outros Projetos</label>
                      <textarea class="form-control" name="interfaceOutrosSistemasProjeto" id="interfacesOutrosSistemasProj" rows="5" ></textarea>
                    </div>
                    <div class="form-group col-md-12">
                      <label for="prazosEstimadosProj">Prazo Estimado</label>
                      <input class="form-control" name="prazosEstimadosProjeto" id="prazosEstimadosProj" type="date" />
                    </div>
                    <div class="form-group col-md-12">
                      <label for="entregasProj">Entregas</label>
                      <!--<textarea class="form-control" name="entregasProjeto" id="entregasProj" rows="6"></textarea>-->
                      <div class="table-controls">
                        <button id="add-row" type="button" class="action-button btn  btn-success">
                          <font style="vertical-align: inherit;">
                            <font style="vertical-align: inherit;">Adicionar Entregável</font>
                          </font>
                        </button>
                      </div>
                      <form action="" method="post">
                        <div id="example-table"></div>
                        <input type="hidden" id="tableDataEntr" name="entregaveis" value=""/>
                      </form>
                    </div>
                    <div class="form-group col-md-12">
                      <label for="orcamentoProj">Orçamento Estimado</label>
                      <input class="form-control" name="orcamentoEstimado" id="orcamentoProj" type="number"></input>
                    </div>
                    <div class="form-group col-md-12">
                        
                      <label for="equipeProj" >Equipe</label>
                      <ul id="equipeProj">

                        <% if(dadosTutor[0] != undefined) { %>  
                        <li> <%= dadosTutor[0].nomeUsuario %></li>                        
                        <%
                        }
                          var equipe = dadosTermoAbertura.equipe;
                          for(var i=0; i < equipe.length; i++){
                          %>
                           <li><%= equipe[i].nomeUsuario %></li>
                          <%
                          }
                         %> 
                      </ul>
                    </div>
                    <div class="form-group col-md-12" >
                      <label for="restricoesProj">Restrições</label>
                      <textarea class="form-control" name="restricoesProjeto" id="restricoesProj" rows="6"></textarea>
                    </div>
                    <div class="form-group col-md-12">
                      <input type="button" id="btnCriarEquipe"  class="submit action-button btn  btn-success col-md-offset-5" value="Enviar" onclick="submeterForm()" />
                    </div>
                  </div>

                </div>


              </fieldset>

            </form>
          </div>
        </div>

         <a id="alertErroModal" href="#" data-toggle="modal" data-target="#modalErroValidacaoTA"></a>



      </div>
      <!-- jQuery -->
      <script src="http://thecodeplayer.com/uploads/js/jquery-1.9.1.min.js" type="text/javascript"></script>
      <!-- jQuery easing plugin -->
      <script src="http://thecodeplayer.com/uploads/js/jquery.easing.min.js" type="text/javascript"></script>
     <!-- <script src="js/script_multiform.js" type="text/javascript"></script>-->

    </section><!-- /.content -->
  </div><!-- /.content-wrapper -->

    <script src="plugins/jQuery/jQuery-2.1.3.min.js"></script>
    <script type="text/javascript" src="jquery-ui-1.12.1/jquery-ui.min.js"></script>
    <!-- Bootstrap 3.3.2 JS -->
    <script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <!-- FastClick -->
    <script src='plugins/fastclick/fastclick.min.js'></script>
    <!-- AdminLTE App -->
    <script src="dist/js/app.min.js" type="text/javascript"></script>
    <!-- Sparkline -->
    <script src="plugins/sparkline/jquery.sparkline.min.js" type="text/javascript"></script>
    <!-- jvectormap -->
    <script src="plugins/jvectormap/jquery-jvectormap-1.2.2.min.js" type="text/javascript"></script>
    <script src="plugins/jvectormap/jquery-jvectormap-world-mill-en.js" type="text/javascript"></script>
    <!-- daterangepicker -->
    <script src="plugins/daterangepicker/daterangepicker.js" type="text/javascript"></script>
    <!-- datepicker -->
    <script src="plugins/datepicker/bootstrap-datepicker.js" type="text/javascript"></script>
    <!-- iCheck -->
    <script src="plugins/iCheck/icheck.min.js" type="text/javascript"></script>
    <!-- SlimScroll 1.3.0 -->
    <script src="plugins/slimScroll/jquery.slimscroll.min.js" type="text/javascript"></script>
    <!-- ChartJS 1.0.1 -->
    <script src="plugins/chartjs/Chart.min.js" type="text/javascript"></script>

    <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
    <script src="dist/js/pages/dashboard2.js" type="text/javascript"></script>

    <!-- AdminLTE for demo purposes -->
    <script src="dist/js/demo.js" type="text/javascript"></script>

    <!--<script src="js/script_multiform.js" type="text/javascript"></script>-->

    <script type="text/javascript" src="tabulator-master/dist/js/tabulator.min.js"></script>

    <script type="text/javascript" src="moment/moment.js"></script>

    <script>
      var mensagensErro = document.getElementById("msgsTAErro");
      var contPos=0;
      var tableData = null;
      var dateEditor = function(cell, onRendered, success, cancel, editorParams){
        //cell - the cell component for the editable cell
        //onRendered - function to call when the editor has been rendered
        //success - function to call to pass the successfuly updated value to Tabulator
        //cancel - function to call to abort the edit and return to a normal cell
        //editorParams - params object passed into the editorParams column definition property

        //create and style editor
        var editor = document.createElement("input");

        editor.setAttribute("type", "date");

        //create and style input
        editor.style.padding = "3px";
        editor.style.width = "100%";
        editor.style.boxSizing = "border-box";

        //Set value of editor to the current value of the cell
        editor.value = moment(cell.getValue(), "DD/MM/YYYY").format("YYYY-MM-DD")

        //set focus on the select box when the editor is selected (timeout allows for editor to be added to DOM)
        onRendered(function(){
            editor.focus();
            editor.style.css = "100%";
        });

        //when the value has been set, trigger the cell to update
        function successFunc(){
            success(moment(editor.value, "YYYY-MM-DD").format("DD/MM/YYYY"));
        }

        //editor.addEventListener("change", successFunc);
        editor.addEventListener("blur", successFunc);

        //return the editor element
        return editor;
    };

      var table = new Tabulator("#example-table", {
        placeholder:"Adicione os entregáveis do projeto",

        selectable:true,
        addRowPos : "bottom" ,

        columns:[
          {title:"Descrição", field:"descricao", sorter:"string", width:200, editor:true},
          {title:"Data Inicial", field:"dataInicial", sorter:"date", align:"center", formatter:"html", editor:dateEditor},
          {title:"Data Final", field:"dataFinal", sorter:"date", align:"center", formatter:"html", editor:dateEditor},
          {title:"Status", field:"status", sorter:"string", editor:"select", editorParams:{
            "A iniciar":"A iniciar",
            "Em execução":"Em execução",
            "Pausado":"Pausado",
            "Finalizado":"Finalizado",
            }},
          {title:"Observações", field:"observacoes", formatter:"textarea", align:"left", width:200, editor:true},
          {title:"", field:"del", formatter:"html", align:"left", width:20, editor:false}
        ],
        index:"id",
        rowFormatter:function(row){
        },
      });

      table.hideColumn("id");

      //Add row on "Add Row" button click
      $("#add-row").click(function(){
        var cont = contPos;
        table.addRow({
          id:cont,
          status:"A iniciar",
          observacoes:"",
          del: "<span class=\"glyphicon glyphicon-remove\" onclick=\"removerLinha("+cont+")\"><\/span>"
        });
        contPos++;
      });



      function removerLinha(pos){
        var row = table.getRow(pos);
        table.deleteRow(row.getIndex());
      }

      function submeterForm(){
        var i = 0;
        var data = table.getData();

        limparMensagensErro();

        for(i=0;i<data.length;i++){
          data[i].dataInicial = moment(data[i].dataInicial,"DD/MM/YYYY").format("YYYY-MM-DD");
          data[i].dataFinal = moment(data[i].dataFinal,"DD/MM/YYYY").format("YYYY-MM-DD");    
        }

        var formEhValido = validarCampos(data);
        console.log("formEhValido = "+formEhValido);

        if(formEhValido){
           var dataJSON = JSON.stringify(data); 
            var tableDataEntr = document.getElementById("tableDataEntr");
            tableDataEntr.setAttribute("value",dataJSON);
           $("#msform").submit();
        } else {
           document.getElementById("alertErroModal").click();
        } 

       
      }

      function validarCampos(data){
        var dtPrazoEstimadoValido = validarDataPrazoEstimado();
        var dtEntregaveisValido = validarEntregaveis(data);
        console.log("dtPrazoEstimadoValido = "+dtPrazoEstimadoValido);
        console.log("dtEntregaveisValido = "+dtEntregaveisValido);

        var ehValido = dtPrazoEstimadoValido && dtEntregaveisValido

        return ehValido;
      }

      function validarDataPrazoEstimado(){
        var ehValido = true;

        var q = new Date();
        var m = q.getMonth()+1;
        var d = q.getDate();
        var y = q.getFullYear();

        var dtPrazoEstimado = moment(document.getElementById("prazosEstimadosProj").value);
        var dtHoje = moment(y+"-"+m+"-"+d);

        if(dtPrazoEstimado < dtHoje){
          ehValido = false;
          mensagensErro.append(adicionarMensagemErro("Data de prazo estimado é anterior a hoje"));
        }

        return ehValido;

      }

      function validarEntregaveis(data){
          
          var ehValido = true;
          var entr;
          var dtIni;
          var dtFin;

          if(data.length > 0){
            for(var i=0;i<data.length;i++){
              entr = data[i];
              dtIni = moment(data[i].dataInicial,"DD/MM/YYYY").format("YYYY-MM-DD");
              dtFin = moment(data[i].dataFinal,"DD/MM/YYYY").format("YYYY-MM-DD"); 

              if(dtFin < dtIni){
                ehValido = false;
                mensagensErro.append(adicionarMensagemErro("Data Final do entregável "+entr.descricao+" é menor do que a sua data inicial"));
              }

            }     
          } else {
            ehValido = false;
            mensagensErro.append(adicionarMensagemErro("É obrigatório definir os entregaveis do projeto"));
          }


          return ehValido;

      }

       function adicionarMensagemErro(msg){

         var p = document.createElement("p");
         var small = document.createElement("small");
         var msgErro = document.createTextNode(msg);
         small.append(msgErro);
         p.append(small);

         return p;
      }

      function limparMensagensErro(){
          while (mensagensErro.firstChild) {
            mensagensErro.removeChild(mensagensErro.firstChild);
          }
      }

    </script>
  </body>
</html>
